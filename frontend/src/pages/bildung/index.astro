---
import ContentLayout from '../../layouts/ContentLayout.astro';
import Hero from '../../components/common/Hero.astro';
import RichText from '../../components/common/RichText.astro';
import Breadcrumb from '../../components/common/Breadcrumb.astro';
import ExternalLinkCard from '../../components/common/ExternalLinkCard.astro';
import { getSectionBySlug, getStrapiMedia } from '../../lib/strapi';

let section: any = null;
let error = false;

try {
  const response = await getSectionBySlug('bildung');
  const sections = response.data || [];
  section = sections[0] || null;
} catch (e) {
  console.error('Failed to fetch section "bildung":', e);
  error = true;
}

const heroImage = section?.heroImage ? getStrapiMedia(section.heroImage.url) : undefined;
const subPages = section?.subPages || [];
const externalLinks = section?.externalLinks || [];

const sidebarLinks = [
  ...subPages.map((sp: any) => ({
    title: sp.title,
    slug: sp.slug,
    href: `/bildung/${sp.slug}`,
  })),
  { title: 'Veranstaltungen', slug: 'veranstaltungen', href: '/bildung/veranstaltungen' },
];

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Bildung' },
];
---

<ContentLayout
  title="Bildung"
  section="Bildung"
  showSidebar={sidebarLinks.length > 0}
  sidebarLinks={sidebarLinks}
>
  <Breadcrumb items={breadcrumbs} />

  {section ? (
    <Hero
      title={section.name || 'Bildung'}
      image={heroImage}
    />
  ) : (
    <Hero title="Bildung" />
  )}

  <div class="mt-8">
    {error && (
      <p class="text-gray-500 italic mb-8">
        Inhalte konnten nicht geladen werden. Bitte versuchen Sie es sp&auml;ter erneut.
      </p>
    )}

    {section?.description && (
      <div class="mb-10">
        <RichText content={section.description} />
      </div>
    )}

    {/* Sub-page cards */}
    {subPages.length > 0 && (
      <section class="mb-10">
        <h2 class="text-xl font-semibold text-primary-800 mb-6">Bereiche</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {subPages.map((sp: any) => (
            <a
              href={`/bildung/${sp.slug}`}
              class="group block bg-white rounded-xl border border-gray-200 p-5 no-underline hover:shadow-md hover:border-primary-300 transition-all duration-200"
            >
              <h3 class="text-lg font-semibold text-primary-800 group-hover:text-primary-600 transition-colors mb-2">
                {sp.title}
              </h3>
              <span class="text-sm text-primary-600 group-hover:text-primary-500">
                Mehr erfahren &rarr;
              </span>
            </a>
          ))}
        </div>
      </section>
    )}

    {/* Veranstaltungen link */}
    <section class="mb-10">
      <a
        href="/bildung/veranstaltungen"
        class="group flex items-center gap-3 bg-primary-50 border border-primary-200 rounded-xl p-5 no-underline hover:bg-primary-100 hover:border-primary-300 transition-all duration-200"
      >
        <svg class="w-8 h-8 text-primary-600 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
        </svg>
        <div>
          <h3 class="text-lg font-semibold text-primary-800 group-hover:text-primary-600 transition-colors">
            Veranstaltungen
          </h3>
          <p class="text-sm text-gray-600">Aktuelle Termine und Events im Bereich Bildung</p>
        </div>
      </a>
    </section>

    {/* External links (www entries) */}
    {externalLinks.length > 0 && (
      <section class="mb-10">
        <h2 class="text-xl font-semibold text-primary-800 mb-6">Im Web</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {externalLinks.map((link: any) => (
            <ExternalLinkCard
              name={link.name}
              url={link.url}
              teaser={link.teaser}
              logo={link.logo ? getStrapiMedia(link.logo.url) : undefined}
            />
          ))}
        </div>
      </section>
    )}
  </div>
</ContentLayout>
