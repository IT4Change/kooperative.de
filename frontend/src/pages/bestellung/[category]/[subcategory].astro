---
import ShopLayout from '../../../layouts/ShopLayout.astro';
import Breadcrumb from '../../../components/common/Breadcrumb.astro';
import { getCategories, getCategoryBySlug, getProductsBySubcategory, getSubcategoryBySlug, getStrapiMedia } from '../../../lib/strapi';

export async function getStaticPaths() {
  try {
    const response = await getCategories();
    const categories = response.data || [];

    const paths: any[] = [];
    for (const cat of categories) {
      const subcategories = cat.subcategories || [];
      for (const sub of subcategories) {
        paths.push({
          params: { category: cat.slug, subcategory: sub.slug },
          props: {
            categoryData: cat,
            subcategoryData: sub,
          },
        });
      }
    }
    return paths;
  } catch (e) {
    console.error('Failed to fetch categories/subcategories for static paths:', e);
    return [];
  }
}

const { category: categorySlug, subcategory: subcategorySlug } = Astro.params;
const { categoryData: preloadedCat, subcategoryData: preloadedSub } = Astro.props;

let categoryData = preloadedCat;
let subcategoryData = preloadedSub;
let products: any[] = [];
let allCategories: any[] = [];
let allSubcategories: any[] = [];
let error = false;

try {
  // Fetch full category with subcategories
  const catResponse = await getCategoryBySlug(categorySlug!);
  const cats = catResponse.data || [];
  if (cats.length > 0) {
    categoryData = cats[0];
  }
  allSubcategories = categoryData?.subcategories || [];

  // Fetch subcategory details
  const subResponse = await getSubcategoryBySlug(subcategorySlug!);
  const subs = subResponse.data || [];
  if (subs.length > 0) {
    subcategoryData = subs[0];
  }

  // Fetch products for this subcategory
  const prodResponse = await getProductsBySubcategory(subcategorySlug!);
  products = prodResponse.data || [];

  // Fetch all categories for sidebar
  const allCatResponse = await getCategories();
  allCategories = allCatResponse.data || [];
} catch (e) {
  console.error(`Failed to fetch subcategory data for "${subcategorySlug}":`, e);
  error = true;
}

if (!categoryData || !subcategoryData) {
  return Astro.redirect('/404');
}

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Bestellung', href: '/bestellung/' },
  { label: categoryData.name, href: `/bestellung/${categorySlug}` },
  { label: subcategoryData.name },
];
---

<ShopLayout title={`${subcategoryData.name} - ${categoryData.name}`} activeCategory={categorySlug}>
  <Fragment slot="sidebar">
    <ul class="space-y-1">
      {allCategories.map((cat: any) => {
        const isActive = cat.slug === categorySlug;
        return (
          <li>
            <a
              href={`/bestellung/${cat.slug}`}
              class:list={[
                'block px-3 py-2 rounded-md text-sm transition-colors',
                isActive
                  ? 'bg-primary-100 text-primary-800 font-semibold'
                  : 'text-gray-600 hover:bg-primary-50 hover:text-primary-700',
              ]}
            >
              {cat.name}
            </a>
            {isActive && allSubcategories.length > 0 && (
              <ul class="ml-4 mt-1 space-y-1">
                {allSubcategories.map((sub: any) => {
                  const isSubActive = sub.slug === subcategorySlug;
                  return (
                    <li>
                      <a
                        href={`/bestellung/${categorySlug}/${sub.slug}`}
                        class:list={[
                          'block px-3 py-1.5 rounded-md text-xs transition-colors',
                          isSubActive
                            ? 'bg-primary-50 text-primary-700 font-semibold'
                            : 'text-gray-500 hover:bg-primary-50 hover:text-primary-700',
                        ]}
                        aria-current={isSubActive ? 'page' : undefined}
                      >
                        {sub.name}
                      </a>
                    </li>
                  );
                })}
              </ul>
            )}
          </li>
        );
      })}
    </ul>
  </Fragment>

  <Breadcrumb items={breadcrumbs} />

  <h1 class="mb-2">{subcategoryData.name}</h1>
  <p class="text-sm text-gray-500 mb-6">{categoryData.name}</p>

  {error && (
    <p class="text-gray-500 italic mb-8">
      Produkte konnten nicht geladen werden. Bitte versuchen Sie es sp&auml;ter erneut.
    </p>
  )}

  {/* Subcategory filter links */}
  {allSubcategories.length > 0 && (
    <nav class="mb-8" aria-label="Unterkategorien">
      <div class="flex flex-wrap gap-2">
        <a
          href={`/bestellung/${categorySlug}`}
          class="inline-block px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 border border-gray-200 no-underline hover:bg-primary-50 hover:text-primary-700 hover:border-primary-200 transition-colors"
        >
          Alle
        </a>
        {allSubcategories.map((sub: any) => {
          const isActive = sub.slug === subcategorySlug;
          return (
            <a
              href={`/bestellung/${categorySlug}/${sub.slug}`}
              class:list={[
                'inline-block px-4 py-2 rounded-full text-sm font-medium no-underline transition-colors',
                isActive
                  ? 'bg-primary-100 text-primary-800 border border-primary-200'
                  : 'bg-white text-gray-600 border border-gray-200 hover:bg-primary-50 hover:text-primary-700 hover:border-primary-200',
              ]}
              aria-current={isActive ? 'page' : undefined}
            >
              {sub.name}
            </a>
          );
        })}
      </div>
    </nav>
  )}

  {/* Search placeholder */}
  <div class="mb-8" id="search-container">
    <div class="relative">
      <input
        type="search"
        placeholder="Produkte durchsuchen..."
        class="w-full px-4 py-3 pl-10 rounded-lg border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-primary-300 focus:border-primary-300"
        id="product-search"
      />
      <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
      </svg>
    </div>
  </div>

  {/* Product grid */}
  {products.length > 0 ? (
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="product-grid">
      {products.map((product: any) => {
        const image = product.images?.[0] ? getStrapiMedia(product.images[0].url) : null;
        return (
          <a
            href={`/bestellung/produkt/${product.slug}`}
            class="group block bg-white rounded-xl border border-gray-200 overflow-hidden no-underline hover:shadow-lg hover:border-primary-300 transition-all duration-200"
            data-product-name={product.name.toLowerCase()}
          >
            {image ? (
              <div class="aspect-square overflow-hidden bg-gray-100">
                <img
                  src={image}
                  alt={product.name}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                  loading="lazy"
                />
              </div>
            ) : (
              <div class="aspect-square bg-gray-100 flex items-center justify-center">
                <svg class="w-12 h-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 21h16.5A2.25 2.25 0 0 0 22.5 18.75V5.25A2.25 2.25 0 0 0 20.25 3H3.75A2.25 2.25 0 0 0 1.5 5.25v13.5A2.25 2.25 0 0 0 3.75 21Z" />
                </svg>
              </div>
            )}
            <div class="p-4">
              <h3 class="text-base font-semibold text-gray-800 group-hover:text-primary-700 transition-colors mb-1 line-clamp-2">
                {product.name}
              </h3>
              <div class="flex items-center justify-between">
                <span class="text-lg font-bold text-primary-800">
                  {product.price.toFixed(2).replace('.', ',')} &euro;
                </span>
                {!product.inStock && (
                  <span class="text-xs text-red-500 font-medium">Nicht verf&uuml;gbar</span>
                )}
              </div>
            </div>
          </a>
        );
      })}
    </div>
  ) : (
    !error && (
      <p class="text-gray-500 italic">
        In dieser Unterkategorie sind noch keine Produkte verf&uuml;gbar.
      </p>
    )
  )}
</ShopLayout>

<script>
  // Simple client-side search filter
  const searchInput = document.getElementById('product-search') as HTMLInputElement;
  const productGrid = document.getElementById('product-grid');

  if (searchInput && productGrid) {
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase().trim();
      const cards = productGrid.querySelectorAll<HTMLElement>('[data-product-name]');

      cards.forEach((card) => {
        const name = card.dataset.productName || '';
        card.style.display = name.includes(query) ? '' : 'none';
      });
    });
  }
</script>
