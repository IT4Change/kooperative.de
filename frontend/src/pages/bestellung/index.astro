---
import ShopLayout from '../../layouts/ShopLayout.astro';
import Breadcrumb from '../../components/common/Breadcrumb.astro';
import { getCategories, getStrapiMedia } from '../../lib/strapi';

let categories: any[] = [];
let error = false;

try {
  const response = await getCategories();
  categories = response.data || [];
} catch (e) {
  console.error('Failed to fetch categories:', e);
  error = true;
}

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Bestellung' },
];
---

<ShopLayout title="Bestellung">
  <Fragment slot="sidebar">
    <ul class="space-y-1">
      {categories.map((cat: any) => (
        <li>
          <a
            href={`/bestellung/${cat.slug}`}
            class="block px-3 py-2 rounded-md text-sm text-gray-600 hover:bg-primary-50 hover:text-primary-700 transition-colors"
          >
            {cat.name}
          </a>
        </li>
      ))}
    </ul>
  </Fragment>

  <Breadcrumb items={breadcrumbs} />

  <h1 class="mb-6">Bestellung</h1>

  {/* How it works section */}
  <section class="mb-10">
    <h2 class="text-xl font-semibold text-primary-800 mb-4">Wie es geht</h2>
    <div class="bg-white rounded-xl border border-gray-200 p-6 md:p-8">
      <ol class="space-y-4 list-decimal list-inside text-gray-700">
        <li class="leading-relaxed">
          <strong class="text-primary-800">Produkte ausw&auml;hlen</strong> &ndash;
          St&ouml;bern Sie durch unsere Kategorien und legen Sie Produkte in den Warenkorb.
        </li>
        <li class="leading-relaxed">
          <strong class="text-primary-800">Warenkorb pr&uuml;fen</strong> &ndash;
          &Uuml;berpr&uuml;fen Sie Ihre Auswahl und passen Sie die Mengen an.
        </li>
        <li class="leading-relaxed">
          <strong class="text-primary-800">Bestellung aufgeben</strong> &ndash;
          Geben Sie Ihre Kontaktdaten ein und senden Sie die Bestellung ab.
        </li>
        <li class="leading-relaxed">
          <strong class="text-primary-800">Best&auml;tigung erhalten</strong> &ndash;
          Sie erhalten eine Best&auml;tigung und wir melden uns bei Ihnen zur Abholung oder Lieferung.
        </li>
      </ol>
    </div>
  </section>

  {error && (
    <p class="text-gray-500 italic mb-8">
      Kategorien konnten nicht geladen werden. Bitte versuchen Sie es sp&auml;ter erneut.
    </p>
  )}

  {/* Category cards grid */}
  {categories.length > 0 && (
    <section>
      <h2 class="text-xl font-semibold text-primary-800 mb-6">Unsere Produkte</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {categories.map((cat: any) => {
          const subcategoryCount = cat.subcategories?.length || 0;
          return (
            <a
              href={`/bestellung/${cat.slug}`}
              class="group block bg-white rounded-xl border border-gray-200 p-6 no-underline hover:shadow-lg hover:border-primary-300 transition-all duration-200"
            >
              <h3 class="text-lg font-semibold text-primary-800 group-hover:text-primary-600 transition-colors mb-2">
                {cat.name}
              </h3>
              {cat.description && (
                <p class="text-sm text-gray-600 leading-relaxed mb-3 line-clamp-2">
                  {cat.description}
                </p>
              )}
              <div class="flex items-center justify-between">
                <span class="text-xs text-gray-400">
                  {subcategoryCount} {subcategoryCount === 1 ? 'Unterkategorie' : 'Unterkategorien'}
                </span>
                <span class="text-sm text-primary-600 group-hover:text-primary-500 font-medium">
                  Ansehen &rarr;
                </span>
              </div>
            </a>
          );
        })}
      </div>
    </section>
  )}

  {!error && categories.length === 0 && (
    <p class="text-gray-500 italic">
      Es sind noch keine Produktkategorien verf&uuml;gbar.
    </p>
  )}
</ShopLayout>
